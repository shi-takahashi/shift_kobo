# お知らせ機能の使い方

アプリ内で全ユーザーに対してお知らせを配信する方法を説明します。

## 前提条件

- Firebase Console にアクセスできること
- プロジェクト選択権限があること

---

## お知らせの作成手順

### 1. Firebase Console を開く

1. https://console.firebase.google.com/ にアクセス
2. プロジェクトを選択:
   - **開発環境**: `shift-kobo-online`
   - **本番環境**: `shift-kobo-online-prod`

### 2. Firestore Database を開く

1. 左メニューから **Firestore Database** をクリック
2. `announcements` コレクションを探す
   - 初回の場合は存在しないので、次のステップで作成

### 3. お知らせドキュメントを追加

1. `announcements` コレクションをクリック（なければ「**コレクションを開始**」をクリックして `announcements` と入力）
2. **ドキュメントを追加** をクリック
3. **ドキュメントID**: 自動ID（何も入力しない）
4. 以下のフィールドを追加:

---

## フィールド設定

### 必須フィールド

| フィールド名 | 型 | 説明 | 設定例 |
|------------|-------|------|--------|
| `title` | string | お知らせのタイトル | `メンテナンスのお知らせ` |
| `message` | string | お知らせの本文（改行可能） | `本日22:00〜23:00の間、メンテナンスを実施します。` |
| `createdAt` | timestamp | 作成日時 | 現在の日時を選択 |
| `isActive` | boolean | 有効/無効の切り替え | `true` (チェックを入れる) |

### 任意フィールド（表示期間を制御したい場合）

| フィールド名 | 型 | 説明 | 設定例 |
|------------|-------|------|--------|
| `startDate` | timestamp または null | 表示開始日時（未来の日時を設定すると予約投稿） | `2025-11-01 00:00:00` または空欄 |
| `endDate` | timestamp または null | 表示終了日時（過ぎると自動的に非表示） | `2025-11-30 23:59:59` または空欄 |

---

## 設定パターン

### パターン1: すぐに表示、期限なし（最も一般的）

```
title: "新機能追加のお知らせ"
message: "マイページ機能を追加しました。"
createdAt: 2025-10-25 10:00:00
isActive: true
startDate: (空欄)
endDate: (空欄)
```

→ **すぐに全ユーザーに表示され、手動で無効化するまで表示され続ける**

---

### パターン2: 予約投稿（未来の日時から表示開始）

```
title: "年末年始の営業について"
message: "12月29日〜1月3日は休業します。"
createdAt: 2025-10-25 10:00:00
isActive: true
startDate: 2025-12-20 00:00:00  ← 12月20日から表示
endDate: (空欄)
```

→ **12月20日以降に表示開始**

---

### パターン3: 期間限定のお知らせ

```
title: "キャンペーンのお知らせ"
message: "11月1日〜11月30日限定でキャンペーン実施中！"
createdAt: 2025-10-25 10:00:00
isActive: true
startDate: 2025-11-01 00:00:00  ← 11月1日から表示
endDate: 2025-11-30 23:59:59    ← 12月1日以降は非表示
```

→ **11月1日〜11月30日のみ表示**

---

### パターン4: すぐ表示、1週間後に自動削除

```
title: "緊急メンテナンスのお知らせ"
message: "本日22:00にメンテナンスを実施します。"
createdAt: 2025-10-25 10:00:00
isActive: true
startDate: (空欄)
endDate: 2025-11-01 23:59:59  ← 1週間後に自動非表示
```

→ **すぐ表示、11月2日以降は自動的に非表示**

---

## お知らせの無効化（表示を停止）

お知らせを手動で停止したい場合：

1. Firebase Console で該当のお知らせドキュメントを開く
2. `isActive` フィールドを `false` に変更
3. **保存**

→ すぐに全ユーザーに表示されなくなります（既読データは残る）

---

## 改行の使い方

`message` フィールドは改行に対応しています。

**Firebase Console での入力例**:
```
これは1行目です。
これは2行目です。
これは3行目です。
```

**アプリでの表示**:
```
これは1行目です。
これは2行目です。
これは3行目です。
```

---

## 複数のお知らせがある場合の動作

- **未読のお知らせが複数ある場合**: `createdAt` が最新のお知らせのみ表示
- **1つ閉じた後**: 次回アプリ起動時に、残りの未読お知らせが表示される
- **既読のお知らせ**: 同じユーザーには二度と表示されない

---

## トラブルシューティング

### お知らせが表示されない

#### 1. `isActive` が `true` になっているか確認
- Firebase Console で該当ドキュメントを開き、`isActive` フィールドを確認

#### 2. `startDate` が未来になっていないか確認
- `startDate` が設定されている場合、現在時刻より前の日時になっているか確認

#### 3. `endDate` が過去になっていないか確認
- `endDate` が設定されている場合、現在時刻より後の日時になっているか確認

#### 4. ユーザーがすでに既読にしていないか確認
- Firebase Console → `users/{userId}` → `readAnnouncementIds` フィールドを確認
- 該当のお知らせIDが含まれている場合は既読済み

### 既読をリセットしたい場合（テスト用）

Firebase Console で以下を実施：

1. `users/{userId}` ドキュメントを開く
2. `readAnnouncementIds` フィールドを削除 または 空配列 `[]` に変更
3. **保存**

→ 該当ユーザーに再度お知らせが表示されます

---

## 注意事項

- **削除したお知らせは復元できません**
- **既読データは永続的に保存されます**（お知らせを削除しても、既読データは残る）
- **テスト環境と本番環境は別々**なので、それぞれで設定が必要

---

## よくある質問

### Q1. 特定のユーザーだけにお知らせを送れますか？
A1. 現在の実装では全ユーザー対象です。個別連絡が必要な場合はメールサポートを利用してください。

### Q2. プッシュ通知は送られますか？
A2. いいえ。アプリを起動した時にのみ表示されます。

### Q3. お知らせの履歴は見れますか？
A3. 現在は最新の未読お知らせのみ表示されます。過去のお知らせ一覧機能は未実装です。

### Q4. お知らせの文字数制限はありますか？
A4. 技術的な制限はありませんが、長すぎると読みづらいため、200文字程度を推奨します。

---

このガイドは `docs/announcement-guide.md` に保存されています。
